# CdMEC-A: Contextual mDNA Mobile Element Classifier - Analyzer
# Copyright (C) 2025 [Dr. Reema Singh]
# Licensed under the GNU General Public License v3.0

import pandas as pd
import glob
import os
import argparse

def get_manuscript_stats(output_dir):
    # Locate all summary files generated by CdMEC-A
    all_files = glob.glob(os.path.join(output_dir, "*_summary.tsv"))

    if not all_files:
        print(f"Error: No summary files found in {output_dir}")
        return

    # Aggregate individual sample reports into one master dataset
    full_df = pd.concat([pd.read_csv(f, sep='\t') for f in all_files], ignore_index=True)

    print("\n" + "="*50)
    print(" CdMEC-A MANUSCRIPT SUMMARY STATISTICS ")
    print("="*50)

    # General Sample and Hit Counts
    print(f"Total Samples Analyzed:       {full_df['Sample_ID'].nunique()}")
    print(f"Total Associated ARGs Found: {len(full_df)}")

    # Breakdown by Inferred Association Status
    print("\n[MGE Association Classifications]")
    status_counts = full_df['Inferred_Status'].value_counts()
    for status, count in status_counts.items():
        percentage = (count / len(full_df)) * 100
        print(f" - {status:.<30} {count} ({percentage:.1f}%)")

    # Physical Distance Metrics
    print("\n[Proximity Analysis (Distance in bp)]")
    # Using absolute value to represent physical distance regardless of Up/Downstream
    proximity_stats = full_df['Proximity_bp'].abs().describe()
    print(f" - Mean Distance:  {proximity_stats['mean']:.2f} bp")
    print(f" - Median (50%):   {proximity_stats['50%']:.2f} bp")
    print(f" - Std Deviation:  {proximity_stats['std']:.2f} bp")
    print(f" - Range:          {proximity_stats['min']:.0f} - {proximity_stats['max']:.0f} bp")
    print("="*50 + "\n")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Generate CdMEC-A stats for manuscript.")
    parser.add_argument("-i", "--input", required=True, help="Directory containing *_summary.tsv files")
    args = parser.parse_args()

    get_manuscript_stats(args.input)
